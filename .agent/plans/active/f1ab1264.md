# Plan: Versioned schema migrations for deaddrop

**ID:** f1ab1264
**Created:** 2026-01-21 03:42:29 UTC
**Updated:** 2026-01-21 03:51:40 UTC
**Status:** in-progress
**Session:** 308968c3-3947-4b0c-87ef-b1fb834d2086

## Context

## Current State

- **Database**: SQLite locally, Turso (libSQL) in production
- **Schema management**: Currently uses `CREATE TABLE IF NOT EXISTS` in `init_db()`
- **Problem**: No way to add columns to existing tables (e.g., `content_type` on messages)
- **Recent change**: Added `content_type TEXT DEFAULT 'text/plain'` to messages table schema, but existing databases won't get this column

## Tables
1. `namespaces` - namespace configuration
2. `identities` - user/agent identities within namespaces  
3. `messages` - the messages (needs `content_type` column added)
4. `invites` - invite links for onboarding
5. `archive_batches` - archive tracking

## Requirements
- Track schema version in database
- Apply incremental migrations on startup
- Support both SQLite and Turso/libSQL
- First migration: add `content_type` column to existing `messages` tables

## Implementation Approach

## Approach

### Schema Version Tracking
Add a `schema_version` table to track the current database version:
```sql
CREATE TABLE IF NOT EXISTS schema_version (
    version INTEGER PRIMARY KEY,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    description TEXT
);
```

### Migration System Design
1. **Migrations as functions**: Each migration is a Python function that takes a connection
2. **Version tracking**: After each migration, insert a row into `schema_version`
3. **Idempotent**: Check current version before applying migrations
4. **Ordered**: Migrations have sequential version numbers (1, 2, 3, ...)

### Migration Runner
```python
MIGRATIONS = [
    (1, "Add content_type to messages", migrate_001_add_content_type),
    # Future migrations added here
]

def run_migrations(conn):
    current_version = get_current_version(conn)
    for version, description, migrate_fn in MIGRATIONS:
        if version > current_version:
            migrate_fn(conn)
            record_migration(conn, version, description)
```

### First Migration (001)
```sql
-- Add content_type column if it doesn't exist
ALTER TABLE messages ADD COLUMN content_type TEXT DEFAULT 'text/plain';
```

Note: SQLite doesn't support `IF NOT EXISTS` for `ALTER TABLE ADD COLUMN`, so we need to check column existence first via `PRAGMA table_info(messages)`.

### Integration
- Call `run_migrations()` from `init_db()` after creating tables
- New databases get tables with all columns, then migrations mark them as applied
- Existing databases get columns added via migrations

## Tasks

- ✓✓ **Add schema_version table and version tracking functions** (id: c5eeb5df)
  - Details: Create schema_version table, get_schema_version(), record_migration() functions
  - Files: src/deadrop/db.py
  - Tests: Test version tracking in isolation
  - Verification: All 112 tests pass. Schema version tracking tests:
- test_get_schema_version_empty_db PASSED
- test_record_and_get_migration PASSED
- test_multiple_migrations_return_max_version PASSED

- ✓✓ **Implement migration runner infrastructure** (id: 97394d7b)
  - Details: Create MIGRATIONS list, run_migrations() function, column existence check helper
  - Files: src/deadrop/db.py
  - Tests: Test migration runner with mock migrations
  - Verification: Migration runner tests pass:
- test_run_migrations_on_fresh_db PASSED
- test_run_migrations_skips_already_applied PASSED
- test_run_migrations_idempotent PASSED

- ✓✓ **Create migration 001: add content_type column to messages** (id: a7fdef3b)
  - Details: Migration function that adds content_type column if missing, with DEFAULT 'text/plain'
  - Files: src/deadrop/db.py
  - Tests: Test migration on DB without content_type column
  - Verification: Migration 001 tests pass:
- test_migration_adds_column_when_missing PASSED
- test_migration_is_idempotent PASSED
- test_migration_default_value PASSED

- ✓✓ **Integrate migrations into init_db()** (id: 632d81dd)
  - Details: Call run_migrations() after table creation, handle fresh vs existing DB
  - Files: src/deadrop/db.py
  - Tests: Integration test: fresh DB and upgrade scenarios
  - Verification: Integration tests pass:
- test_init_db_runs_migrations PASSED
- test_fresh_db_has_all_columns PASSED

- ✓✓ **Add comprehensive migration tests** (id: e615f4c4)
  - Details: Test fresh install, upgrade from pre-migration, idempotency, error handling
  - Files: tests/test_migrations.py
  - Tests: New test file for migration system
  - Verification: All 13 migration tests pass in tests/test_migrations.py. Full test suite: 112 tests pass.

## Considerations

- **Common patterns we might need:** 

## Progress Log

- [2026-01-21 03:42] Plan created: Versioned schema migrations for deaddrop
- [2026-01-21 03:44] Updated context
- [2026-01-21 03:45] Updated approach
- [2026-01-21 03:45] Updated considerations
- [2026-01-21 03:45] Added 5 tasks
- [2026-01-21 03:46] Plan submitted for review
- [2026-01-21 03:47] Plan approved for execution
- [2026-01-21 03:47] Plan execution started
- [2026-01-21 03:48] Completed task c5eeb5df: Added schema_version table, get_schema_version(), record_migration(), and _column_exists() helper functions
- [2026-01-21 03:49] Completed task 97394d7b: Added MIGRATIONS registry and run_migrations() function
- [2026-01-21 03:49] Completed task a7fdef3b: Migration 001 (_migrate_001_add_content_type) was implemented as part of the migration runner infrastructure
- [2026-01-21 03:49] Completed task 632d81dd: Added run_migrations(conn) call at the end of init_db()
- [2026-01-21 03:51] Completed task e615f4c4: Added 13 comprehensive migration tests covering version tracking, column checks, migration 001, migration runner, and init_db integration
- [2026-01-21 03:51] Verified task c5eeb5df
- [2026-01-21 03:51] Verified task 97394d7b
- [2026-01-21 03:51] Verified task a7fdef3b
- [2026-01-21 03:51] Verified task 632d81dd
- [2026-01-21 03:51] Verified task e615f4c4

---

<!-- plan-data
{
  "id": "f1ab1264",
  "title": "Versioned schema migrations for deaddrop",
  "status": "in-progress",
  "session_id": "308968c3-3947-4b0c-87ef-b1fb834d2086",
  "created_at": "2026-01-21T03:42:29.400048+00:00",
  "updated_at": "2026-01-21T03:51:40.696943+00:00",
  "root_dirs": [
    "/Users/seanfitz/development/deaddrop"
  ],
  "storage_location": "local",
  "pull_request": "",
  "shelved": false,
  "remote_workspace": "",
  "remote_branch": "",
  "remote_started_at": null,
  "context": "## Current State\n\n- **Database**: SQLite locally, Turso (libSQL) in production\n- **Schema management**: Currently uses `CREATE TABLE IF NOT EXISTS` in `init_db()`\n- **Problem**: No way to add columns to existing tables (e.g., `content_type` on messages)\n- **Recent change**: Added `content_type TEXT DEFAULT 'text/plain'` to messages table schema, but existing databases won't get this column\n\n## Tables\n1. `namespaces` - namespace configuration\n2. `identities` - user/agent identities within namespaces  \n3. `messages` - the messages (needs `content_type` column added)\n4. `invites` - invite links for onboarding\n5. `archive_batches` - archive tracking\n\n## Requirements\n- Track schema version in database\n- Apply incremental migrations on startup\n- Support both SQLite and Turso/libSQL\n- First migration: add `content_type` column to existing `messages` tables",
  "approach": "## Approach\n\n### Schema Version Tracking\nAdd a `schema_version` table to track the current database version:\n```sql\nCREATE TABLE IF NOT EXISTS schema_version (\n    version INTEGER PRIMARY KEY,\n    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    description TEXT\n);\n```\n\n### Migration System Design\n1. **Migrations as functions**: Each migration is a Python function that takes a connection\n2. **Version tracking**: After each migration, insert a row into `schema_version`\n3. **Idempotent**: Check current version before applying migrations\n4. **Ordered**: Migrations have sequential version numbers (1, 2, 3, ...)\n\n### Migration Runner\n```python\nMIGRATIONS = [\n    (1, \"Add content_type to messages\", migrate_001_add_content_type),\n    # Future migrations added here\n]\n\ndef run_migrations(conn):\n    current_version = get_current_version(conn)\n    for version, description, migrate_fn in MIGRATIONS:\n        if version > current_version:\n            migrate_fn(conn)\n            record_migration(conn, version, description)\n```\n\n### First Migration (001)\n```sql\n-- Add content_type column if it doesn't exist\nALTER TABLE messages ADD COLUMN content_type TEXT DEFAULT 'text/plain';\n```\n\nNote: SQLite doesn't support `IF NOT EXISTS` for `ALTER TABLE ADD COLUMN`, so we need to check column existence first via `PRAGMA table_info(messages)`.\n\n### Integration\n- Call `run_migrations()` from `init_db()` after creating tables\n- New databases get tables with all columns, then migrations mark them as applied\n- Existing databases get columns added via migrations",
  "tasks": [
    {
      "id": "c5eeb5df",
      "description": "Add schema_version table and version tracking functions",
      "details": "Create schema_version table, get_schema_version(), record_migration() functions",
      "files": [
        "src/deadrop/db.py"
      ],
      "tests": "Test version tracking in isolation",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "All 112 tests pass. Schema version tracking tests:\n- test_get_schema_version_empty_db PASSED\n- test_record_and_get_migration PASSED\n- test_multiple_migrations_return_max_version PASSED"
    },
    {
      "id": "97394d7b",
      "description": "Implement migration runner infrastructure",
      "details": "Create MIGRATIONS list, run_migrations() function, column existence check helper",
      "files": [
        "src/deadrop/db.py"
      ],
      "tests": "Test migration runner with mock migrations",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "Migration runner tests pass:\n- test_run_migrations_on_fresh_db PASSED\n- test_run_migrations_skips_already_applied PASSED\n- test_run_migrations_idempotent PASSED"
    },
    {
      "id": "a7fdef3b",
      "description": "Create migration 001: add content_type column to messages",
      "details": "Migration function that adds content_type column if missing, with DEFAULT 'text/plain'",
      "files": [
        "src/deadrop/db.py"
      ],
      "tests": "Test migration on DB without content_type column",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "Migration 001 tests pass:\n- test_migration_adds_column_when_missing PASSED\n- test_migration_is_idempotent PASSED\n- test_migration_default_value PASSED"
    },
    {
      "id": "632d81dd",
      "description": "Integrate migrations into init_db()",
      "details": "Call run_migrations() after table creation, handle fresh vs existing DB",
      "files": [
        "src/deadrop/db.py"
      ],
      "tests": "Integration test: fresh DB and upgrade scenarios",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "Integration tests pass:\n- test_init_db_runs_migrations PASSED\n- test_fresh_db_has_all_columns PASSED"
    },
    {
      "id": "e615f4c4",
      "description": "Add comprehensive migration tests",
      "details": "Test fresh install, upgrade from pre-migration, idempotency, error handling",
      "files": [
        "tests/test_migrations.py"
      ],
      "tests": "New test file for migration system",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "All 13 migration tests pass in tests/test_migrations.py. Full test suite: 112 tests pass."
    }
  ],
  "milestones": [],
  "questions": [],
  "considerations": {
    "Common patterns we might need": ""
  },
  "progress_log": [
    {
      "timestamp": "2026-01-21T03:42:29.400124+00:00",
      "message": "Plan created: Versioned schema migrations for deaddrop"
    },
    {
      "timestamp": "2026-01-21T03:44:52.548020+00:00",
      "message": "Updated context"
    },
    {
      "timestamp": "2026-01-21T03:45:11.355579+00:00",
      "message": "Updated approach"
    },
    {
      "timestamp": "2026-01-21T03:45:27.328663+00:00",
      "message": "Updated considerations"
    },
    {
      "timestamp": "2026-01-21T03:45:46.194225+00:00",
      "message": "Added 5 tasks"
    },
    {
      "timestamp": "2026-01-21T03:46:12.875824+00:00",
      "message": "Plan submitted for review"
    },
    {
      "timestamp": "2026-01-21T03:47:32.485970+00:00",
      "message": "Plan approved for execution"
    },
    {
      "timestamp": "2026-01-21T03:47:45.254565+00:00",
      "message": "Plan execution started"
    },
    {
      "timestamp": "2026-01-21T03:48:31.374666+00:00",
      "message": "Completed task c5eeb5df: Added schema_version table, get_schema_version(), record_migration(), and _column_exists() helper functions"
    },
    {
      "timestamp": "2026-01-21T03:49:02.140849+00:00",
      "message": "Completed task 97394d7b: Added MIGRATIONS registry and run_migrations() function"
    },
    {
      "timestamp": "2026-01-21T03:49:15.867491+00:00",
      "message": "Completed task a7fdef3b: Migration 001 (_migrate_001_add_content_type) was implemented as part of the migration runner infrastructure"
    },
    {
      "timestamp": "2026-01-21T03:49:56.949371+00:00",
      "message": "Completed task 632d81dd: Added run_migrations(conn) call at the end of init_db()"
    },
    {
      "timestamp": "2026-01-21T03:51:19.352469+00:00",
      "message": "Completed task e615f4c4: Added 13 comprehensive migration tests covering version tracking, column checks, migration 001, migration runner, and init_db integration"
    },
    {
      "timestamp": "2026-01-21T03:51:37.277685+00:00",
      "message": "Verified task c5eeb5df"
    },
    {
      "timestamp": "2026-01-21T03:51:38.104670+00:00",
      "message": "Verified task 97394d7b"
    },
    {
      "timestamp": "2026-01-21T03:51:39.022403+00:00",
      "message": "Verified task a7fdef3b"
    },
    {
      "timestamp": "2026-01-21T03:51:39.841818+00:00",
      "message": "Verified task 632d81dd"
    },
    {
      "timestamp": "2026-01-21T03:51:40.696941+00:00",
      "message": "Verified task e615f4c4"
    }
  ],
  "completion_notes": "",
  "metrics": {
    "definitions": [],
    "snapshots": [],
    "execution_started_at": "2026-01-21T03:47:45.255635+00:00",
    "baseline_input_tokens": 160,
    "baseline_output_tokens": 20444,
    "baseline_thinking_tokens": 0,
    "baseline_cached_tokens": 3481314,
    "baseline_cost_dollars": 4.2056539
  }
}
-->