# Plan: Deaddrop v2: Fix concurrency bug and add rooms/improved onboarding

**ID:** f145c758
**Created:** 2026-01-26 02:43:48 UTC
**Updated:** 2026-01-26 02:50:48 UTC
**Status:** in-progress
**Approval Policy:** interactive
**Session:** e015b30b-1be9-4ff9-876c-bc1838897bee

## Context

## Current Issues

### 1. Critical: SQLite Concurrency Bug
The long-polling implementation causes `sqlite3.InterfaceError: bad parameter or other API misuse` under concurrent load.

**Root cause:** The async `get_inbox` endpoint with `wait` parameter calls `db.has_new_messages()` in a loop with `asyncio.sleep()`. Multiple concurrent requests share the same global SQLite connection (`_conn`), and SQLite connections are NOT safe to use from multiple async coroutines simultaneously.

**Evidence from experiment:**
- Both Alice and Bob agents crashed with 500 errors
- Server log showed: `sqlite3.InterfaceError: bad parameter or other API misuse`
- Error occurred in `db.send_message()` when executing `SELECT id FROM identities WHERE ns = ? AND id = ?`

### 2. Missing: Multi-user Communication
Current model is strictly 1:1 inbox messaging. The debate experiment required agents to CC the moderator manually on every message. Need a way for multiple participants to communicate in a shared context.

**Options to consider:**
- **Rooms**: A dedicated inbox that any participant can read/write. Simple but breaks "only owner reads inbox" security model.
- **Broadcast/Group**: Sender sends once, system delivers to all recipients. Preserves inbox ownership but creates duplicate storage.

### 3. UX: Namespace Joining Flow
Current join flow is fragmented:
- Web users: Invite URL → claim → credentials
- CLI users: Manual configuration
- Local users: `deadrop ns create --local`

Need unified experience: **always join via invite URL** (works for web, CLI, and local).

### 4. Missing: Multi-source CLI Support  
CLI currently can only connect to one backend at a time. Need to support:
- Multiple local `.deaddrop` directories
- Multiple remote servers
- Mixed local + remote namespaces

## Clarification Questions

- [x] **For multi-user communication, which model do you prefer?**
  - Options: ROOMS: Shared inbox that any member can read/write. Simple but relaxes security (non-owners can read)., BROADCAST: Sender's message delivered to all recipients. Preserves inbox security but duplicates storage., BOTH: Add rooms for group chat AND keep 1:1 for private. Let users choose per conversation., OTHER: You have a different idea in mind.
  - **Answer:** BOTH: Add rooms for group chat AND keep 1:1 for private. Let users choose per conversation.

- [x] **If we add rooms, how should read/unread tracking work?**
  - Options: PER-USER: Each participant has their own read cursor (like Slack threads), SIMPLE: No read tracking for rooms, just chronological messages, HYBRID: Track 'last read' timestamp per user but don't mark messages as read
  - **Answer:** PER-USER: Each participant has their own read cursor (like Slack threads)

- [x] **For local namespaces, should invite URLs work via CLI claim?**
  - Options: YES: `deadrop invite claim <url>` works for both local and remote invites, SEPARATE: Local uses different flow since there's no server to call, FILE-BASED: Local invites are shareable config files instead of URLs
  - **Answer:** YES: `deadrop invite claim <url>` works for both local and remote invites

- [x] **What's the priority order for these changes?**
  - Options: 1. Bug fix → 2. Rooms → 3. Invite flow → 4. Multi-source CLI, 1. Bug fix → 2. Invite flow → 3. Rooms → 4. Multi-source CLI, 1. Bug fix only for now, plan the rest separately, OTHER: Different priority
  - **Answer:** 1. Bug fix → 2. Rooms → 3. Invite flow → 4. Multi-source CLI

## Implementation Approach

## Implementation Approach

### Phase 1: Fix SQLite Concurrency Bug (Critical)

**Problem:** Global SQLite connection shared across async coroutines is not thread-safe.

**Solution:** Use connection-per-request pattern for the API:

1. **Option A: Thread-local connections** - Use `threading.local()` to give each thread its own connection
2. **Option B: Connection pool** - Implement a simple connection pool with checkout/checkin
3. **Option C: Async-safe wrapper** - Use `asyncio.Lock` to serialize database access (simple but may reduce throughput)

**Recommended: Option A (Thread-local)** - FastAPI runs sync functions in a thread pool, so thread-local connections work well. Modify `db.py`:
```python
import threading
_local = threading.local()

def get_connection():
    if not hasattr(_local, 'conn') or _local.conn is None:
        _local.conn = sqlite3.connect(db_path, check_same_thread=False)
        _local.conn.row_factory = sqlite3.Row
    return _local.conn
```

### Phase 2: Add Rooms

**Data Model:**
```sql
CREATE TABLE rooms (
    room_id TEXT PRIMARY KEY,
    ns TEXT NOT NULL REFERENCES namespaces(ns),
    slug TEXT,
    display_name TEXT,
    created_by TEXT,  -- identity that created it
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE room_members (
    room_id TEXT REFERENCES rooms(room_id),
    identity_id TEXT,
    ns TEXT,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_read_mid TEXT,  -- cursor for per-user read tracking
    PRIMARY KEY (room_id, identity_id)
);

CREATE TABLE room_messages (
    mid TEXT PRIMARY KEY,
    room_id TEXT REFERENCES rooms(room_id),
    from_id TEXT NOT NULL,
    body TEXT NOT NULL,
    content_type TEXT DEFAULT 'text/plain',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Security Model:**
- Room creator becomes first member
- Members can invite other identities from same namespace
- Any member can read all messages in room
- Any member can post to room
- Non-members cannot access room

**API:**
```
POST /{ns}/rooms                         # Create room
GET /{ns}/rooms/{room_id}                # Get room info
POST /{ns}/rooms/{room_id}/members       # Add member
GET /{ns}/rooms/{room_id}/messages       # Read messages (with ?wait for long-poll)
POST /{ns}/rooms/{room_id}/messages      # Post message
POST /{ns}/rooms/{room_id}/read          # Update read cursor
```

### Phase 3: Unified Invite Flow

**Design:**
- All joins happen via invite URLs: `https://server/invite/{invite_id}#key` or `deadrop://invite/{invite_id}#key`
- Web: Opens browser UI to claim
- CLI: `deadrop invite claim <url>` extracts and saves credentials
- Local: CLI can generate invite URLs that encode local path + credentials

**Local invite URL format:**
```
deadrop://local/invite?path=/path/to/.deaddrop&ns=xxx&id=xxx&secret_enc=xxx#decryption_key
```

### Phase 4: Multi-source CLI

**Config structure (~/.config/deadrop/config.yaml):**
```yaml
sources:
  - name: "work"
    type: remote
    url: "https://work.deaddrop.io"
    namespaces:
      - ns: "abc123"
        identities: ["id1", "id2"]
  - name: "local-project"
    type: local
    path: "/path/to/project/.deaddrop"
    namespaces:
      - ns: "def456"
        identities: ["id3"]

default_source: "work"
```

**CLI changes:**
- `deadrop source list` - List configured sources
- `deadrop source add <name> --remote <url>` or `--local <path>`
- `deadrop ns list --source <name>` or `--all`
- Most commands get `--source` flag, defaults to `default_source`

## Tasks

###  Phase 1: Critical Bug Fix (0✓/1)
_Fix the SQLite concurrency bug that causes 500 errors under load_

- ⬜ **Fix SQLite concurrency bug with thread-local connections** (id: 022468e7) [READY]
  - Details: Modify db.py to use threading.local() for per-thread connections. Update get_connection() to create/reuse thread-local conn. Add proper cleanup. Enable WAL mode for better concurrency.
  - Files: s, r, c, /, d, e, a, d, r, o, p, /, d, b, ., p, y
  - Tests: Add concurrent request test that reproduces the bug, verify it passes after fix

###  Phase 2: Room Support (0✓/4)
_Add multi-user rooms for group communication_

- ⬜ **Add rooms database schema and migrations** (id: 92bf9681) [READY]
  - Details: Create rooms, room_members, room_messages tables. Add migration for schema version 2. Include indexes for efficient queries.
  - Files: s, r, c, /, d, e, a, d, r, o, p, /, d, b, ., p, y
  - Tests: Test migration runs cleanly on fresh and existing databases

- ⬜ **Implement room CRUD operations in db.py** (id: 8b92f1ba) [READY]
  - Details: Add functions: create_room, get_room, list_rooms, add_room_member, remove_room_member, list_room_members, send_room_message, get_room_messages (with pagination and wait support), update_read_cursor, get_unread_count
  - Files: s, r, c, /, d, e, a, d, r, o, p, /, d, b, ., p, y
  - Tests: Unit tests for all room operations

- ⬜ **Add room API endpoints** (id: e8f69bbc) [READY]
  - Details: POST /{ns}/rooms, GET /{ns}/rooms/{room_id}, POST /{ns}/rooms/{room_id}/members, DELETE /{ns}/rooms/{room_id}/members/{id}, GET /{ns}/rooms/{room_id}/messages (with ?wait), POST /{ns}/rooms/{room_id}/messages, POST /{ns}/rooms/{room_id}/read
  - Files: s, r, c, /, d, e, a, d, r, o, p, /, a, p, i, ., p, y
  - Tests: API tests for room endpoints including auth

- ⬜ **Add room support to backends and client** (id: c5390de0) [READY]
  - Details: Extend Backend ABC with room methods. Implement in LocalBackend, RemoteBackend, InMemoryBackend. Add room methods to Deaddrop client class.
  - Files: s, r, c, /, d, e, a, d, r, o, p, /, b, a, c, k, e, n, d, s, ., p, y, ,,  , s, r, c, /, d, e, a, d, r, o, p, /, c, l, i, e, n, t, ., p, y
  - Tests: Backend and client tests for room operations

###  Phase 3: Improved Onboarding (0✓/3)
_Unified invite flow and multi-source CLI_

- ⬜ **Implement unified invite claim for CLI** (id: ca031250) [READY]
  - Details: Add `deadrop invite claim <url>` command that parses invite URLs (both remote https:// and local deadrop:// schemes), claims the invite, and saves credentials to config.
  - Files: s, r, c, /, d, e, a, d, r, o, p, /, c, l, i, ., p, y
  - Tests: Test claim flow for remote and local invites

- ⬜ **Add multi-source configuration support** (id: bee1272e) [READY]
  - Details: Create config schema for multiple sources (remote URLs and local paths). Add source management commands: source list, source add, source remove, source default. Update existing commands to accept --source flag.
  - Files: s, r, c, /, d, e, a, d, r, o, p, /, c, l, i, ., p, y, ,,  , s, r, c, /, d, e, a, d, r, o, p, /, c, o, n, f, i, g, ., p, y
  - Tests: Test multi-source configuration and command routing

- ⬜ **Update documentation for rooms and new CLI** (id: 6a2fa97f) [READY]
  - Details: Update README with room examples. Add docs/ROOMS.md guide. Update CLI help text. Update docs/LOCAL_NAMESPACES.md with new invite flow.
  - Files: R, E, A, D, M, E, ., m, d, ,,  , d, o, c, s, /, R, O, O, M, S, ., m, d, ,,  , d, o, c, s, /, L, O, C, A, L, _, N, A, M, E, S, P, A, C, E, S, ., m, d
  - Tests: Documentation review

## Considerations

- **- In-memory DB (`:** memory:`) won't work with thread-local (each thread gets separate DB) - need file-based for tests or single-thread mode
- **- Alternative:** Use WAL mode for better concurrent read/write
- **### Rooms vs 1:** 1
- **- Consider:** room admin role vs just "member"
- **- Existing 1:** 1 messaging unchanged
- **- Long-polling on rooms:** notify when any message arrives

## Progress Log

- [2026-01-26 02:43] Plan created: Deaddrop v2: Fix concurrency bug and add rooms/improved onboarding
- [2026-01-26 02:44] Updated context
- [2026-01-26 02:46] Clarified 4 questions with user
- [2026-01-26 02:46] Updated approach
- [2026-01-26 02:47] Updated considerations
- [2026-01-26 02:47] Added 8 tasks
- [2026-01-26 02:48] Added milestone: Phase 1: Critical Bug Fix
- [2026-01-26 02:48] Added milestone: Phase 2: Room Support
- [2026-01-26 02:48] Added milestone: Phase 3: Improved Onboarding
- [2026-01-26 02:49] Plan submitted for review
- [2026-01-26 02:50] Plan approved for execution
- [2026-01-26 02:50] Plan execution started

---

<!-- plan-data
{
  "id": "f145c758",
  "title": "Deaddrop v2: Fix concurrency bug and add rooms/improved onboarding",
  "status": "in-progress",
  "session_id": "e015b30b-1be9-4ff9-876c-bc1838897bee",
  "created_at": "2026-01-26T02:43:48.759472+00:00",
  "updated_at": "2026-01-26T02:50:48.940777+00:00",
  "root_dirs": [
    "/Users/seanfitz/development/deaddrop"
  ],
  "storage_location": "local",
  "pull_request": "",
  "shelved": false,
  "remote_workspace": "",
  "remote_branch": "",
  "remote_started_at": null,
  "context": "## Current Issues\n\n### 1. Critical: SQLite Concurrency Bug\nThe long-polling implementation causes `sqlite3.InterfaceError: bad parameter or other API misuse` under concurrent load.\n\n**Root cause:** The async `get_inbox` endpoint with `wait` parameter calls `db.has_new_messages()` in a loop with `asyncio.sleep()`. Multiple concurrent requests share the same global SQLite connection (`_conn`), and SQLite connections are NOT safe to use from multiple async coroutines simultaneously.\n\n**Evidence from experiment:**\n- Both Alice and Bob agents crashed with 500 errors\n- Server log showed: `sqlite3.InterfaceError: bad parameter or other API misuse`\n- Error occurred in `db.send_message()` when executing `SELECT id FROM identities WHERE ns = ? AND id = ?`\n\n### 2. Missing: Multi-user Communication\nCurrent model is strictly 1:1 inbox messaging. The debate experiment required agents to CC the moderator manually on every message. Need a way for multiple participants to communicate in a shared context.\n\n**Options to consider:**\n- **Rooms**: A dedicated inbox that any participant can read/write. Simple but breaks \"only owner reads inbox\" security model.\n- **Broadcast/Group**: Sender sends once, system delivers to all recipients. Preserves inbox ownership but creates duplicate storage.\n\n### 3. UX: Namespace Joining Flow\nCurrent join flow is fragmented:\n- Web users: Invite URL \u2192 claim \u2192 credentials\n- CLI users: Manual configuration\n- Local users: `deadrop ns create --local`\n\nNeed unified experience: **always join via invite URL** (works for web, CLI, and local).\n\n### 4. Missing: Multi-source CLI Support  \nCLI currently can only connect to one backend at a time. Need to support:\n- Multiple local `.deaddrop` directories\n- Multiple remote servers\n- Mixed local + remote namespaces",
  "approach": "## Implementation Approach\n\n### Phase 1: Fix SQLite Concurrency Bug (Critical)\n\n**Problem:** Global SQLite connection shared across async coroutines is not thread-safe.\n\n**Solution:** Use connection-per-request pattern for the API:\n\n1. **Option A: Thread-local connections** - Use `threading.local()` to give each thread its own connection\n2. **Option B: Connection pool** - Implement a simple connection pool with checkout/checkin\n3. **Option C: Async-safe wrapper** - Use `asyncio.Lock` to serialize database access (simple but may reduce throughput)\n\n**Recommended: Option A (Thread-local)** - FastAPI runs sync functions in a thread pool, so thread-local connections work well. Modify `db.py`:\n```python\nimport threading\n_local = threading.local()\n\ndef get_connection():\n    if not hasattr(_local, 'conn') or _local.conn is None:\n        _local.conn = sqlite3.connect(db_path, check_same_thread=False)\n        _local.conn.row_factory = sqlite3.Row\n    return _local.conn\n```\n\n### Phase 2: Add Rooms\n\n**Data Model:**\n```sql\nCREATE TABLE rooms (\n    room_id TEXT PRIMARY KEY,\n    ns TEXT NOT NULL REFERENCES namespaces(ns),\n    slug TEXT,\n    display_name TEXT,\n    created_by TEXT,  -- identity that created it\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE TABLE room_members (\n    room_id TEXT REFERENCES rooms(room_id),\n    identity_id TEXT,\n    ns TEXT,\n    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    last_read_mid TEXT,  -- cursor for per-user read tracking\n    PRIMARY KEY (room_id, identity_id)\n);\n\nCREATE TABLE room_messages (\n    mid TEXT PRIMARY KEY,\n    room_id TEXT REFERENCES rooms(room_id),\n    from_id TEXT NOT NULL,\n    body TEXT NOT NULL,\n    content_type TEXT DEFAULT 'text/plain',\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n```\n\n**Security Model:**\n- Room creator becomes first member\n- Members can invite other identities from same namespace\n- Any member can read all messages in room\n- Any member can post to room\n- Non-members cannot access room\n\n**API:**\n```\nPOST /{ns}/rooms                         # Create room\nGET /{ns}/rooms/{room_id}                # Get room info\nPOST /{ns}/rooms/{room_id}/members       # Add member\nGET /{ns}/rooms/{room_id}/messages       # Read messages (with ?wait for long-poll)\nPOST /{ns}/rooms/{room_id}/messages      # Post message\nPOST /{ns}/rooms/{room_id}/read          # Update read cursor\n```\n\n### Phase 3: Unified Invite Flow\n\n**Design:**\n- All joins happen via invite URLs: `https://server/invite/{invite_id}#key` or `deadrop://invite/{invite_id}#key`\n- Web: Opens browser UI to claim\n- CLI: `deadrop invite claim <url>` extracts and saves credentials\n- Local: CLI can generate invite URLs that encode local path + credentials\n\n**Local invite URL format:**\n```\ndeadrop://local/invite?path=/path/to/.deaddrop&ns=xxx&id=xxx&secret_enc=xxx#decryption_key\n```\n\n### Phase 4: Multi-source CLI\n\n**Config structure (~/.config/deadrop/config.yaml):**\n```yaml\nsources:\n  - name: \"work\"\n    type: remote\n    url: \"https://work.deaddrop.io\"\n    namespaces:\n      - ns: \"abc123\"\n        identities: [\"id1\", \"id2\"]\n  - name: \"local-project\"\n    type: local\n    path: \"/path/to/project/.deaddrop\"\n    namespaces:\n      - ns: \"def456\"\n        identities: [\"id3\"]\n\ndefault_source: \"work\"\n```\n\n**CLI changes:**\n- `deadrop source list` - List configured sources\n- `deadrop source add <name> --remote <url>` or `--local <path>`\n- `deadrop ns list --source <name>` or `--all`\n- Most commands get `--source` flag, defaults to `default_source`",
  "tasks": [
    {
      "id": "022468e7",
      "description": "Fix SQLite concurrency bug with thread-local connections",
      "details": "Modify db.py to use threading.local() for per-thread connections. Update get_connection() to create/reuse thread-local conn. Add proper cleanup. Enable WAL mode for better concurrency.",
      "files": "src/deadrop/db.py",
      "tests": "Add concurrent request test that reproduces the bug, verify it passes after fix",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "92bf9681",
      "description": "Add rooms database schema and migrations",
      "details": "Create rooms, room_members, room_messages tables. Add migration for schema version 2. Include indexes for efficient queries.",
      "files": "src/deadrop/db.py",
      "tests": "Test migration runs cleanly on fresh and existing databases",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "8b92f1ba",
      "description": "Implement room CRUD operations in db.py",
      "details": "Add functions: create_room, get_room, list_rooms, add_room_member, remove_room_member, list_room_members, send_room_message, get_room_messages (with pagination and wait support), update_read_cursor, get_unread_count",
      "files": "src/deadrop/db.py",
      "tests": "Unit tests for all room operations",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "e8f69bbc",
      "description": "Add room API endpoints",
      "details": "POST /{ns}/rooms, GET /{ns}/rooms/{room_id}, POST /{ns}/rooms/{room_id}/members, DELETE /{ns}/rooms/{room_id}/members/{id}, GET /{ns}/rooms/{room_id}/messages (with ?wait), POST /{ns}/rooms/{room_id}/messages, POST /{ns}/rooms/{room_id}/read",
      "files": "src/deadrop/api.py",
      "tests": "API tests for room endpoints including auth",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "c5390de0",
      "description": "Add room support to backends and client",
      "details": "Extend Backend ABC with room methods. Implement in LocalBackend, RemoteBackend, InMemoryBackend. Add room methods to Deaddrop client class.",
      "files": "src/deadrop/backends.py, src/deadrop/client.py",
      "tests": "Backend and client tests for room operations",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "ca031250",
      "description": "Implement unified invite claim for CLI",
      "details": "Add `deadrop invite claim <url>` command that parses invite URLs (both remote https:// and local deadrop:// schemes), claims the invite, and saves credentials to config.",
      "files": "src/deadrop/cli.py",
      "tests": "Test claim flow for remote and local invites",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "bee1272e",
      "description": "Add multi-source configuration support",
      "details": "Create config schema for multiple sources (remote URLs and local paths). Add source management commands: source list, source add, source remove, source default. Update existing commands to accept --source flag.",
      "files": "src/deadrop/cli.py, src/deadrop/config.py",
      "tests": "Test multi-source configuration and command routing",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "6a2fa97f",
      "description": "Update documentation for rooms and new CLI",
      "details": "Update README with room examples. Add docs/ROOMS.md guide. Update CLI help text. Update docs/LOCAL_NAMESPACES.md with new invite flow.",
      "files": "README.md, docs/ROOMS.md, docs/LOCAL_NAMESPACES.md",
      "tests": "Documentation review",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    }
  ],
  "milestones": [
    {
      "id": "76077995",
      "title": "Phase 1: Critical Bug Fix",
      "description": "Fix the SQLite concurrency bug that causes 500 errors under load",
      "task_ids": [
        "022468e7"
      ],
      "completed": false,
      "order": 0
    },
    {
      "id": "006c848e",
      "title": "Phase 2: Room Support",
      "description": "Add multi-user rooms for group communication",
      "task_ids": [
        "92bf9681",
        "8b92f1ba",
        "e8f69bbc",
        "c5390de0"
      ],
      "completed": false,
      "order": 1
    },
    {
      "id": "a125c314",
      "title": "Phase 3: Improved Onboarding",
      "description": "Unified invite flow and multi-source CLI",
      "task_ids": [
        "ca031250",
        "bee1272e",
        "6a2fa97f"
      ],
      "completed": false,
      "order": 2
    }
  ],
  "questions": [
    {
      "id": "b967c089",
      "question": "For multi-user communication, which model do you prefer?",
      "type": "text",
      "options": [
        "ROOMS: Shared inbox that any member can read/write. Simple but relaxes security (non-owners can read).",
        "BROADCAST: Sender's message delivered to all recipients. Preserves inbox security but duplicates storage.",
        "BOTH: Add rooms for group chat AND keep 1:1 for private. Let users choose per conversation.",
        "OTHER: You have a different idea in mind."
      ],
      "required": true,
      "answer": "BOTH: Add rooms for group chat AND keep 1:1 for private. Let users choose per conversation.",
      "answered_at": "2026-01-26T02:46:21.043147+00:00"
    },
    {
      "id": "51e54144",
      "question": "If we add rooms, how should read/unread tracking work?",
      "type": "text",
      "options": [
        "PER-USER: Each participant has their own read cursor (like Slack threads)",
        "SIMPLE: No read tracking for rooms, just chronological messages",
        "HYBRID: Track 'last read' timestamp per user but don't mark messages as read"
      ],
      "required": true,
      "answer": "PER-USER: Each participant has their own read cursor (like Slack threads)",
      "answered_at": "2026-01-26T02:46:21.043154+00:00"
    },
    {
      "id": "538375ab",
      "question": "For local namespaces, should invite URLs work via CLI claim?",
      "type": "text",
      "options": [
        "YES: `deadrop invite claim <url>` works for both local and remote invites",
        "SEPARATE: Local uses different flow since there's no server to call",
        "FILE-BASED: Local invites are shareable config files instead of URLs"
      ],
      "required": true,
      "answer": "YES: `deadrop invite claim <url>` works for both local and remote invites",
      "answered_at": "2026-01-26T02:46:21.043159+00:00"
    },
    {
      "id": "13514c67",
      "question": "What's the priority order for these changes?",
      "type": "text",
      "options": [
        "1. Bug fix \u2192 2. Rooms \u2192 3. Invite flow \u2192 4. Multi-source CLI",
        "1. Bug fix \u2192 2. Invite flow \u2192 3. Rooms \u2192 4. Multi-source CLI",
        "1. Bug fix only for now, plan the rest separately",
        "OTHER: Different priority"
      ],
      "required": true,
      "answer": "1. Bug fix \u2192 2. Rooms \u2192 3. Invite flow \u2192 4. Multi-source CLI",
      "answered_at": "2026-01-26T02:46:21.043164+00:00"
    }
  ],
  "considerations": {
    "- In-memory DB (`": "memory:`) won't work with thread-local (each thread gets separate DB) - need file-based for tests or single-thread mode",
    "- Alternative": "Use WAL mode for better concurrent read/write",
    "### Rooms vs 1": "1",
    "- Consider": "room admin role vs just \"member\"",
    "- Existing 1": "1 messaging unchanged",
    "- Long-polling on rooms": "notify when any message arrives"
  },
  "progress_log": [
    {
      "timestamp": "2026-01-26T02:43:48.759546+00:00",
      "message": "Plan created: Deaddrop v2: Fix concurrency bug and add rooms/improved onboarding"
    },
    {
      "timestamp": "2026-01-26T02:44:20.955368+00:00",
      "message": "Updated context"
    },
    {
      "timestamp": "2026-01-26T02:46:21.043166+00:00",
      "message": "Clarified 4 questions with user"
    },
    {
      "timestamp": "2026-01-26T02:46:56.057120+00:00",
      "message": "Updated approach"
    },
    {
      "timestamp": "2026-01-26T02:47:21.953081+00:00",
      "message": "Updated considerations"
    },
    {
      "timestamp": "2026-01-26T02:47:53.091436+00:00",
      "message": "Added 8 tasks"
    },
    {
      "timestamp": "2026-01-26T02:48:11.740443+00:00",
      "message": "Added milestone: Phase 1: Critical Bug Fix"
    },
    {
      "timestamp": "2026-01-26T02:48:30.629486+00:00",
      "message": "Added milestone: Phase 2: Room Support"
    },
    {
      "timestamp": "2026-01-26T02:48:49.574198+00:00",
      "message": "Added milestone: Phase 3: Improved Onboarding"
    },
    {
      "timestamp": "2026-01-26T02:49:29.811828+00:00",
      "message": "Plan submitted for review"
    },
    {
      "timestamp": "2026-01-26T02:50:30.404926+00:00",
      "message": "Plan approved for execution"
    },
    {
      "timestamp": "2026-01-26T02:50:48.938749+00:00",
      "message": "Plan execution started"
    }
  ],
  "completion_notes": "",
  "metrics": {
    "definitions": [],
    "snapshots": [],
    "execution_started_at": "2026-01-26T02:50:48.940774+00:00",
    "baseline_input_tokens": 84,
    "baseline_output_tokens": 155063,
    "baseline_thinking_tokens": 0,
    "baseline_cached_tokens": 35750876,
    "baseline_cost_dollars": 48.068133
  },
  "approval_policy": "interactive"
}
-->