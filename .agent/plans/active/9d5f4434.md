# Plan: Publish deadrop package to PyPI

**ID:** 9d5f4434
**Created:** 2026-01-16 03:12:59 UTC
**Updated:** 2026-01-16 04:52:25 UTC
**Status:** in-review
**Session:** 7901ed98-a14a-4cce-abd2-4f986bee9502

## Context

## Current State
- Package name: `deadrop` (user prefers `deaddrop` - need to check PyPI availability)
- Version: 0.1.0
- Repository: Already private on GitHub (clusterfudge/deaddrop)
- CI/CD: release.yml exists with PyPI trusted publishing workflow
- Hardcoded URL: `https://deaddrop.dokku.heare.io` in config.py and tests

## Requirements from User
1. **Package name**: Use `deaddrop` on PyPI
2. **Default URL**: Change to `localhost:8000` (self-hosted first)
3. **Auth system**: Make pluggable via environment variable for module name
   - Extract current heare-auth integration to separate package
   - Allow users to specify custom auth module via envvar
4. **PyPI setup**: Need to configure trusted publishing

## Clarification Questions

- [x] **What package name should be used on PyPI?**
  - **Answer:** deaddrop

- [x] **What should the default server URL be for the CLI?**
  - Options: Remove default entirely (require explicit --url), Keep current default but document it's a demo server, Use localhost:8000 as default
  - **Answer:** Use localhost:8000 as default

- [x] **How should heare-auth references be handled?**
  - Options: Keep as-is (it's a generic auth integration), Rename to generic 'external auth service', Remove heare-auth integration entirely
  - **Answer:** make it pluggable via envvar for module name. then we'll need to package the auth plugin separately (possibly part of heare-auth?) and configure our deployment

- [x] **Do you have a PyPI account set up with trusted publishing for this repo?**
  - Options: Yes, already configured, No, need to set it up, Not sure
  - **Answer:** No, need to set it up

- [x] **What version should the initial PyPI release be?**
  - **Answer:** 0.1.0

## Implementation Approach

## Approach

### 1. Package Name Availability
- Check if `deaddrop` is available on PyPI
- If not, consider alternatives: `deaddrop-messaging`, `deadrop-io`

### 2. Pluggable Auth System
Create a plugin architecture for authentication:
```python
# Environment variable: DEADROP_AUTH_MODULE
# Default: None (no auth required)
# Example: DEADROP_AUTH_MODULE=deadrop_heare_auth.plugin

# The module must expose:
# - verify_token(token: str) -> dict | None
# - is_enabled() -> bool
```

Current `heare_auth.py` becomes a separate package (`deadrop-heare-auth` or part of `heare-auth`).

### 3. Default URL Change
- Change `DEFAULT_SERVER_URL` from `https://deaddrop.dokku.heare.io` to `http://localhost:8000`
- Update tests to match
- Update documentation to emphasize self-hosting

### 4. PyPI Setup
1. Create PyPI account (if needed)
2. Create project on PyPI
3. Configure trusted publishing:
   - Go to PyPI project settings
   - Add GitHub Actions as trusted publisher
   - Repository: clusterfudge/deaddrop
   - Workflow: release.yml
   - Environment: pypi

### 5. Documentation Updates
- Remove/update references to demo server
- Add self-hosting instructions
- Document auth plugin system

## Tasks

- ✓✓ **Verify 'deaddrop' is available on PyPI, or identify alternative names** (id: 666db938)
  - Verification: User manually verified package name 'deaddrop' is available on PyPI

- ✓✓ **Update DEFAULT_SERVER_URL in config.py and fix affected tests** (id: d0f242a6)
  - Verification: Verified config.py already uses localhost:8000 as default at lines 45, 72, and 227

- ✓✓ **Refactor auth to support plugins via entry points, keep heare-auth as built-in option activated by HEARE_AUTH_URL** (id: 34210520)
  - Verification: All 66 tests pass including 14 new tests for auth_provider module

- ✓✓ **Change name in pyproject.toml from 'deadrop' to 'deaddrop'** (id: 94c09022)
  - Verification: All 66 tests pass. Package name updated to 'deaddrop' in pyproject.toml.

- ✓✓ **Remove demo server references, add self-hosting emphasis, document auth plugins** (id: 365c726a)
  - Verification: README updated with installation section, pluggable auth documentation, and removed demo server references

- ⬜ **Create PyPI project and configure trusted publishing for GitHub Actions** (id: 7a02bf51)

- ⬜ **Create a test tag to verify the release workflow works** (id: 34e0272a)

## Considerations

- **Option A:** Environment variable pointing to module
- **Pro:** Auto-discovery, cleaner
- **Con:** More complex
- **Option B:** Entry points (plugins discovered automatically)
- **# In deadrop-heare-auth's pyproject.toml:** 
- **heare = "deadrop_heare_auth:** plugin"
- ****Recommendation**:** Use entry points for cleaner UX, with DEADROP_AUTH_MODULE as override.
- **- Or:** keep heare_auth.py in main package but only activate via envvar
- **### Alternative:** Keep Auth In-Package
- **Instead of extracting heare-auth to separate package:** 
- ****Decision needed**:** Extract to plugin vs keep in-package with envvar activation?

## Progress Log

- [2026-01-16 03:12] Plan created: Publish deadrop package to PyPI
- [2026-01-16 04:29] Clarified 5 questions with user
- [2026-01-16 04:30] Updated context
- [2026-01-16 04:30] Updated approach
- [2026-01-16 04:30] Updated considerations
- [2026-01-16 04:30] Added 7 tasks
- [2026-01-16 04:31] Plan submitted for review
- [2026-01-16 04:33] Completed task 666db938: User confirmed 'deaddrop' is available on PyPI
- [2026-01-16 04:33] Verified task 666db938
- [2026-01-16 04:41] Completed task d0f242a6: Default URL already set to localhost:8000 in config.py
- [2026-01-16 04:41] Verified task d0f242a6
- [2026-01-16 04:48] Completed task 34210520: Created auth_provider.py with pluggable auth system. Supports DEADROP_AUTH_MODULE envvar for custom modules, falls back to built-in heare-auth when HEARE_AUTH_URL is set. Added tests.
- [2026-01-16 04:48] Verified task 34210520
- [2026-01-16 04:50] Completed task 94c09022: Changed package name from 'deadrop' to 'deaddrop' in pyproject.toml
- [2026-01-16 04:50] Verified task 94c09022
- [2026-01-16 04:52] Completed task 365c726a: Updated README: added installation section, documented pluggable auth system, removed demo server references, emphasized self-hosting
- [2026-01-16 04:52] Verified task 365c726a

---

<!-- plan-data
{
  "id": "9d5f4434",
  "title": "Publish deadrop package to PyPI",
  "status": "in-review",
  "session_id": "7901ed98-a14a-4cce-abd2-4f986bee9502",
  "created_at": "2026-01-16T03:12:59.095456+00:00",
  "updated_at": "2026-01-16T04:52:25.552279+00:00",
  "root_dirs": [
    "/Users/seanfitz/development/deaddrop"
  ],
  "storage_location": "local",
  "pull_request": "",
  "shelved": false,
  "remote_workspace": "",
  "remote_branch": "",
  "context": "## Current State\n- Package name: `deadrop` (user prefers `deaddrop` - need to check PyPI availability)\n- Version: 0.1.0\n- Repository: Already private on GitHub (clusterfudge/deaddrop)\n- CI/CD: release.yml exists with PyPI trusted publishing workflow\n- Hardcoded URL: `https://deaddrop.dokku.heare.io` in config.py and tests\n\n## Requirements from User\n1. **Package name**: Use `deaddrop` on PyPI\n2. **Default URL**: Change to `localhost:8000` (self-hosted first)\n3. **Auth system**: Make pluggable via environment variable for module name\n   - Extract current heare-auth integration to separate package\n   - Allow users to specify custom auth module via envvar\n4. **PyPI setup**: Need to configure trusted publishing",
  "approach": "## Approach\n\n### 1. Package Name Availability\n- Check if `deaddrop` is available on PyPI\n- If not, consider alternatives: `deaddrop-messaging`, `deadrop-io`\n\n### 2. Pluggable Auth System\nCreate a plugin architecture for authentication:\n```python\n# Environment variable: DEADROP_AUTH_MODULE\n# Default: None (no auth required)\n# Example: DEADROP_AUTH_MODULE=deadrop_heare_auth.plugin\n\n# The module must expose:\n# - verify_token(token: str) -> dict | None\n# - is_enabled() -> bool\n```\n\nCurrent `heare_auth.py` becomes a separate package (`deadrop-heare-auth` or part of `heare-auth`).\n\n### 3. Default URL Change\n- Change `DEFAULT_SERVER_URL` from `https://deaddrop.dokku.heare.io` to `http://localhost:8000`\n- Update tests to match\n- Update documentation to emphasize self-hosting\n\n### 4. PyPI Setup\n1. Create PyPI account (if needed)\n2. Create project on PyPI\n3. Configure trusted publishing:\n   - Go to PyPI project settings\n   - Add GitHub Actions as trusted publisher\n   - Repository: clusterfudge/deaddrop\n   - Workflow: release.yml\n   - Environment: pypi\n\n### 5. Documentation Updates\n- Remove/update references to demo server\n- Add self-hosting instructions\n- Document auth plugin system",
  "tasks": [
    {
      "id": "666db938",
      "description": "Verify 'deaddrop' is available on PyPI, or identify alternative names",
      "details": "",
      "files": [],
      "tests": "",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "User manually verified package name 'deaddrop' is available on PyPI"
    },
    {
      "id": "d0f242a6",
      "description": "Update DEFAULT_SERVER_URL in config.py and fix affected tests",
      "details": "",
      "files": [],
      "tests": "",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "Verified config.py already uses localhost:8000 as default at lines 45, 72, and 227"
    },
    {
      "id": "34210520",
      "description": "Refactor auth to support plugins via entry points, keep heare-auth as built-in option activated by HEARE_AUTH_URL",
      "details": "",
      "files": [],
      "tests": "",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "All 66 tests pass including 14 new tests for auth_provider module"
    },
    {
      "id": "94c09022",
      "description": "Change name in pyproject.toml from 'deadrop' to 'deaddrop'",
      "details": "",
      "files": [],
      "tests": "",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "All 66 tests pass. Package name updated to 'deaddrop' in pyproject.toml."
    },
    {
      "id": "365c726a",
      "description": "Remove demo server references, add self-hosting emphasis, document auth plugins",
      "details": "",
      "files": [],
      "tests": "",
      "dependencies": [],
      "completed": true,
      "verified": true,
      "verification_notes": "README updated with installation section, pluggable auth documentation, and removed demo server references"
    },
    {
      "id": "7a02bf51",
      "description": "Create PyPI project and configure trusted publishing for GitHub Actions",
      "details": "",
      "files": [],
      "tests": "",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    },
    {
      "id": "34e0272a",
      "description": "Create a test tag to verify the release workflow works",
      "details": "",
      "files": [],
      "tests": "",
      "dependencies": [],
      "completed": false,
      "verified": false,
      "verification_notes": ""
    }
  ],
  "questions": [
    {
      "id": "f857ea22",
      "question": "What package name should be used on PyPI?",
      "type": "text",
      "options": [],
      "required": true,
      "answer": "deaddrop",
      "answered_at": "2026-01-16T04:29:43.048930+00:00"
    },
    {
      "id": "8201a8e3",
      "question": "What should the default server URL be for the CLI?",
      "type": "text",
      "options": [
        "Remove default entirely (require explicit --url)",
        "Keep current default but document it's a demo server",
        "Use localhost:8000 as default"
      ],
      "required": true,
      "answer": "Use localhost:8000 as default",
      "answered_at": "2026-01-16T04:29:43.048948+00:00"
    },
    {
      "id": "e3d5464b",
      "question": "How should heare-auth references be handled?",
      "type": "text",
      "options": [
        "Keep as-is (it's a generic auth integration)",
        "Rename to generic 'external auth service'",
        "Remove heare-auth integration entirely"
      ],
      "required": true,
      "answer": "make it pluggable via envvar for module name. then we'll need to package the auth plugin separately (possibly part of heare-auth?) and configure our deployment",
      "answered_at": "2026-01-16T04:29:43.048962+00:00"
    },
    {
      "id": "d1f6fd23",
      "question": "Do you have a PyPI account set up with trusted publishing for this repo?",
      "type": "text",
      "options": [
        "Yes, already configured",
        "No, need to set it up",
        "Not sure"
      ],
      "required": true,
      "answer": "No, need to set it up",
      "answered_at": "2026-01-16T04:29:43.048978+00:00"
    },
    {
      "id": "b450d50d",
      "question": "What version should the initial PyPI release be?",
      "type": "text",
      "options": [],
      "required": true,
      "answer": "0.1.0",
      "answered_at": "2026-01-16T04:29:43.048991+00:00"
    }
  ],
  "considerations": {
    "Option A": "Environment variable pointing to module",
    "Pro": "Auto-discovery, cleaner",
    "Con": "More complex",
    "Option B": "Entry points (plugins discovered automatically)",
    "# In deadrop-heare-auth's pyproject.toml": "",
    "heare = \"deadrop_heare_auth": "plugin\"",
    "**Recommendation**": "Use entry points for cleaner UX, with DEADROP_AUTH_MODULE as override.",
    "- Or": "keep heare_auth.py in main package but only activate via envvar",
    "### Alternative": "Keep Auth In-Package",
    "Instead of extracting heare-auth to separate package": "",
    "**Decision needed**": "Extract to plugin vs keep in-package with envvar activation?"
  },
  "progress_log": [
    {
      "timestamp": "2026-01-16T03:12:59.095571+00:00",
      "message": "Plan created: Publish deadrop package to PyPI"
    },
    {
      "timestamp": "2026-01-16T04:29:43.048997+00:00",
      "message": "Clarified 5 questions with user"
    },
    {
      "timestamp": "2026-01-16T04:30:03.202772+00:00",
      "message": "Updated context"
    },
    {
      "timestamp": "2026-01-16T04:30:22.340844+00:00",
      "message": "Updated approach"
    },
    {
      "timestamp": "2026-01-16T04:30:41.010281+00:00",
      "message": "Updated considerations"
    },
    {
      "timestamp": "2026-01-16T04:30:59.146798+00:00",
      "message": "Added 7 tasks"
    },
    {
      "timestamp": "2026-01-16T04:31:23.921801+00:00",
      "message": "Plan submitted for review"
    },
    {
      "timestamp": "2026-01-16T04:33:38.355429+00:00",
      "message": "Completed task 666db938: User confirmed 'deaddrop' is available on PyPI"
    },
    {
      "timestamp": "2026-01-16T04:33:51.516249+00:00",
      "message": "Verified task 666db938"
    },
    {
      "timestamp": "2026-01-16T04:41:19.602410+00:00",
      "message": "Completed task d0f242a6: Default URL already set to localhost:8000 in config.py"
    },
    {
      "timestamp": "2026-01-16T04:41:32.957577+00:00",
      "message": "Verified task d0f242a6"
    },
    {
      "timestamp": "2026-01-16T04:48:20.162364+00:00",
      "message": "Completed task 34210520: Created auth_provider.py with pluggable auth system. Supports DEADROP_AUTH_MODULE envvar for custom modules, falls back to built-in heare-auth when HEARE_AUTH_URL is set. Added tests."
    },
    {
      "timestamp": "2026-01-16T04:48:33.529097+00:00",
      "message": "Verified task 34210520"
    },
    {
      "timestamp": "2026-01-16T04:50:42.074024+00:00",
      "message": "Completed task 94c09022: Changed package name from 'deadrop' to 'deaddrop' in pyproject.toml"
    },
    {
      "timestamp": "2026-01-16T04:50:54.777233+00:00",
      "message": "Verified task 94c09022"
    },
    {
      "timestamp": "2026-01-16T04:52:10.011373+00:00",
      "message": "Completed task 365c726a: Updated README: added installation section, documented pluggable auth system, removed demo server references, emphasized self-hosting"
    },
    {
      "timestamp": "2026-01-16T04:52:25.552277+00:00",
      "message": "Verified task 365c726a"
    }
  ],
  "completion_notes": ""
}
-->