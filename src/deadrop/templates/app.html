{% extends "base.html" %}

{% block title %}Deadrop{% endblock %}

{% block body %}
<div id="app">
    <!-- Namespace List View -->
    <div id="view-namespaces" class="view">
        <div class="header">
            <h1>üì¨ Deadrop</h1>
        </div>
        
        <div class="container">
            <h2 style="margin-bottom: 16px;">Your Namespaces</h2>
            
            <div id="namespace-list"></div>
            
            <div id="no-namespaces" class="empty-state hidden">
                <div class="empty-state-icon">üì≠</div>
                <div class="empty-state-title">No namespaces yet</div>
                <p>Get an invite link to join a namespace.</p>
            </div>
            
            <div class="card" style="margin-top: 24px;">
                <h3 style="margin-bottom: 12px;">Have an invite link?</h3>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="invite-url-input" class="form-input" 
                           placeholder="Paste invite URL here...">
                    <button id="invite-go-btn" class="btn btn-primary">Go</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inbox View -->
    <div id="view-inbox" class="view hidden">
        <div class="header">
            <a href="/app" class="back-link" id="inbox-back">‚Üê</a>
            <div>
                <h1 id="inbox-title">Namespace</h1>
                <div class="subtitle" id="inbox-subtitle">as Identity</div>
            </div>
            <div style="margin-left: auto;">
                <a href="#" id="inbox-settings" class="btn btn-icon">‚öôÔ∏è</a>
            </div>
        </div>
        
        <!-- Tab Bar -->
        <div class="tab-bar">
            <a href="#" class="tab active" id="tab-inbox">üì• Inbox</a>
            <a href="#" class="tab" id="tab-rooms">üí¨ Rooms <span class="badge hidden" id="rooms-badge">0</span></a>
        </div>
        
        <div class="toolbar">
            <span style="font-weight: 600;" id="inbox-section-title">Inbox</span>
            <div class="toolbar-actions">
                <a href="#" id="archived-link" class="btn btn-small btn-secondary">üì¶ Archived</a>
                <button id="compose-btn" class="btn btn-small btn-primary">‚úèÔ∏è Compose</button>
            </div>
        </div>
        
        <div id="inbox-loading" class="loading">
            <div class="spinner"></div>
        </div>
        
        <div id="conversation-list"></div>
        
        <div id="inbox-empty" class="empty-state hidden">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-title">No messages yet</div>
            <p>Start a conversation with a peer.</p>
        </div>
    </div>
    
    <!-- Rooms List View -->
    <div id="view-rooms" class="view hidden">
        <div class="header">
            <a href="/app" class="back-link" id="rooms-back">‚Üê</a>
            <div>
                <h1 id="rooms-title">Namespace</h1>
                <div class="subtitle" id="rooms-subtitle">as Identity</div>
            </div>
            <div style="margin-left: auto;">
                <a href="#" id="rooms-settings" class="btn btn-icon">‚öôÔ∏è</a>
            </div>
        </div>
        
        <!-- Tab Bar -->
        <div class="tab-bar">
            <a href="#" class="tab" id="tab-inbox-2">üì• Inbox</a>
            <a href="#" class="tab active" id="tab-rooms-2">üí¨ Rooms <span class="badge hidden" id="rooms-badge-2">0</span></a>
        </div>
        
        <div class="toolbar">
            <span style="font-weight: 600;">Rooms</span>
            <div class="toolbar-actions"></div>
        </div>
        
        <div id="rooms-loading" class="loading hidden">
            <div class="spinner"></div>
        </div>
        
        <div id="room-list"></div>
        
        <div id="rooms-empty" class="empty-state hidden">
            <div class="empty-state-icon">üí¨</div>
            <div class="empty-state-title">No rooms yet</div>
            <p>You're not a member of any rooms.</p>
        </div>
    </div>
    
    <!-- Conversation View (1:1) -->
    <div id="view-conversation" class="view hidden">
        <div class="header">
            <a href="#" class="back-link" id="conversation-back">‚Üê</a>
            <h1 id="conversation-title">Peer</h1>
        </div>
        
        <div id="message-list" class="message-list"></div>
        
        <div class="compose-area">
            <textarea id="message-input" class="compose-input" 
                      placeholder="Type a message..." rows="1"></textarea>
            <button id="send-btn" class="btn btn-primary">Send ‚û§</button>
        </div>
    </div>
    
    <!-- Room Chat View -->
    <div id="view-room-chat" class="view hidden">
        <div class="header">
            <a href="#" class="back-link" id="room-chat-back">‚Üê</a>
            <div>
                <h1 id="room-chat-title">Room</h1>
                <div class="subtitle" id="room-chat-members"></div>
            </div>
        </div>
        
        <div id="room-message-list" class="message-list"></div>
        
        <div class="compose-area">
            <textarea id="room-message-input" class="compose-input" 
                      placeholder="Type a message..." rows="1" enterkeyhint="send"></textarea>
            <button id="room-send-btn" class="btn btn-primary">Send ‚û§</button>
        </div>
    </div>
    
    <!-- Compose Modal -->
    <div id="compose-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div class="card" style="width: 100%; max-width: 480px; margin: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>New Message</h2>
                <button id="compose-cancel" class="btn btn-icon">‚úï</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">To</label>
                <select id="compose-to" class="form-input"></select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Message</label>
                <textarea id="compose-body" class="form-input" rows="4"></textarea>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 8px;">
                <button id="compose-close" class="btn btn-secondary">Cancel</button>
                <button id="compose-send" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
    
    <!-- Archived View -->
    <div id="view-archived" class="view hidden">
        <div class="header">
            <a href="#" class="back-link" id="archived-back">‚Üê</a>
            <h1>Archived Messages</h1>
        </div>
        
        <div class="container">
            <div id="archived-list"></div>
            
            <div id="archived-empty" class="empty-state hidden">
                <div class="empty-state-icon">üì¶</div>
                <div class="empty-state-title">No archived messages</div>
                <p>Archived messages appear here.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // App state
    let currentSlug = {{ slug | tojson if slug else 'null' }};
    let currentPeerId = {{ peer_id | tojson if peer_id is defined and peer_id else 'null' }};
    let currentView = {{ view | tojson if view is defined and view else 'null' }};
    let currentRoomId = {{ room_id | tojson if room_id is defined and room_id else 'null' }};
    let credentials = null;
    let peers = [];
    let messages = [];
    let rooms = [];
    let roomMessages = [];
    let roomMembers = {};
    let roomPollController = null;  // For canceling long-polls (legacy, kept for compat)
    let subscriptionManager = null;  // Unified subscription manager
    
    // DOM elements
    const views = {
        namespaces: document.getElementById('view-namespaces'),
        inbox: document.getElementById('view-inbox'),
        rooms: document.getElementById('view-rooms'),
        conversation: document.getElementById('view-conversation'),
        roomChat: document.getElementById('view-room-chat'),
        archived: document.getElementById('view-archived'),
    };
    
    // Utility functions
    function showView(name) {
        // Cancel any ongoing room polling when leaving room view
        if (name !== 'roomChat' && roomPollController) {
            roomPollController.abort();
            roomPollController = null;
        }
        
        Object.values(views).forEach(v => v.classList.add('hidden'));
        views[name].classList.remove('hidden');
    }
    
    function formatTime(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }
    
    function formatExpiry(expiresAt, ttlHours) {
        if (ttlHours === 0) return null;
        if (!expiresAt) return null;
        
        const remaining = new Date(expiresAt) - new Date();
        if (remaining <= 0) return { text: 'expired', style: 'urgent' };
        
        const hours = Math.floor(remaining / 3600000);
        const mins = Math.floor((remaining % 3600000) / 60000);
        
        if (hours > 3) return { text: `‚è± ${hours}h`, style: '' };
        if (hours > 0) return { text: `‚è± ${hours}h`, style: 'warning' };
        return { text: `‚è± ${mins}m`, style: 'urgent' };
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function getPeerName(id) {
        const peer = peers.find(p => p.id === id);
        return peer?.metadata?.display_name || id.substring(0, 8) + '...';
    }
    
    function getMemberName(id) {
        if (id === credentials?.id) return 'You';
        const member = roomMembers[id];
        return member?.display_name || id.substring(0, 8) + '...';
    }
    
    // ==================== NAMESPACE LIST ====================
    
    function renderNamespaceList() {
        const list = document.getElementById('namespace-list');
        const empty = document.getElementById('no-namespaces');
        const namespaces = CredentialStore.listNamespaces();
        
        if (namespaces.length === 0) {
            list.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        
        empty.classList.add('hidden');
        list.innerHTML = namespaces.map(ns => `
            <div class="card card-clickable" onclick="openNamespace('${ns.slug || ns.ns}')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div class="card-title">${ns.displayName || ns.slug || ns.ns.substring(0, 8)}</div>
                        <div class="card-subtitle">You are: ${ns.activeIdentity?.displayName || 'Unknown'}</div>
                    </div>
                    <span class="mode-badge ${ns.ttlHours === 0 ? 'persistent' : 'ephemeral'}">
                        ${ns.ttlHours === 0 ? 'üìå Persistent' : `‚è± ${ns.ttlHours}h TTL`}
                    </span>
                </div>
            </div>
        `).join('');
    }
    
    // ==================== OPEN NAMESPACE ====================
    
    async function openNamespace(slug) {
        currentSlug = slug;
        credentials = CredentialStore.getCredentials(slug);
        if (!credentials) {
            alert('Credentials not found');
            return;
        }
        
        history.pushState({}, '', `/app/${slug}`);
        
        const nsDisplay = CredentialStore.getNamespace(slug)?.displayName || slug;
        document.getElementById('inbox-title').textContent = nsDisplay;
        document.getElementById('inbox-subtitle').textContent = `as ${credentials.displayName || credentials.id.substring(0, 8)}`;
        document.getElementById('rooms-title').textContent = nsDisplay;
        document.getElementById('rooms-subtitle').textContent = `as ${credentials.displayName || credentials.id.substring(0, 8)}`;
        
        showView('inbox');
        loadInbox();
        loadRoomsInBackground().then(() => {
            // Start unified subscription after we know which rooms we're in
            startSubscription();
        });
    }
    
    // ==================== INBOX ====================
    
    async function loadInbox() {
        const loading = document.getElementById('inbox-loading');
        const list = document.getElementById('conversation-list');
        const empty = document.getElementById('inbox-empty');
        
        loading.classList.remove('hidden');
        list.innerHTML = '';
        
        try {
            const [peersResult, inboxResult] = await Promise.all([
                DeadropAPI.listPeers(credentials),
                DeadropAPI.getInbox(credentials),
            ]);
            
            peers = peersResult;
            messages = inboxResult.messages;
            
            // Update subscription cursor for inbox
            if (subscriptionManager && messages.length > 0) {
                const lastMid = messages[messages.length - 1].mid;
                subscriptionManager.updateCursor(`inbox:${credentials.id}`, lastMid);
            }
            
            loading.classList.add('hidden');
            
            const conversations = {};
            messages.forEach(msg => {
                const peerId = msg.from === credentials.id ? msg.to : msg.from;
                if (!conversations[peerId]) {
                    conversations[peerId] = { peerId, messages: [], hasUnread: false };
                }
                conversations[peerId].messages.push(msg);
                if (!msg.read_at && msg.from !== credentials.id) {
                    conversations[peerId].hasUnread = true;
                }
            });
            
            const sorted = Object.values(conversations).sort((a, b) => {
                const aLatest = a.messages[a.messages.length - 1].created_at;
                const bLatest = b.messages[b.messages.length - 1].created_at;
                return new Date(bLatest) - new Date(aLatest);
            });
            
            if (sorted.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            list.innerHTML = sorted.map(conv => {
                const latest = conv.messages[conv.messages.length - 1];
                const isSent = latest.from === credentials.id;
                const preview = isSent ? `You: ${latest.body}` : latest.body;
                const expiry = formatExpiry(latest.expires_at, credentials.ttlHours);
                
                return `
                    <div class="conversation-item ${conv.hasUnread ? 'unread' : ''}" 
                         onclick="openConversation('${conv.peerId}')">
                        ${conv.hasUnread ? '<div class="unread-dot"></div>' : ''}
                        <div class="conversation-avatar">${getPeerName(conv.peerId)[0].toUpperCase()}</div>
                        <div class="conversation-content">
                            <div class="conversation-header">
                                <span class="conversation-name">${getPeerName(conv.peerId)}</span>
                                <span class="conversation-time">${formatTime(latest.created_at)}</span>
                            </div>
                            <div class="conversation-preview">${preview.substring(0, 50)}${preview.length > 50 ? '...' : ''}</div>
                            ${expiry ? `<span class="ttl-indicator ttl-${expiry.style}">${expiry.text}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
        } catch (e) {
            loading.classList.add('hidden');
            list.innerHTML = `<div class="error-message">${e.message}</div>`;
        }
    }
    
    function openConversation(peerId) {
        currentPeerId = peerId;
        history.pushState({}, '', `/app/${currentSlug}/${peerId}`);
        
        document.getElementById('conversation-title').textContent = getPeerName(peerId);
        showView('conversation');
        renderConversation();
    }
    
    function renderConversation() {
        const list = document.getElementById('message-list');
        const peerMessages = messages.filter(m => 
            m.from === currentPeerId || m.to === currentPeerId
        );
        
        list.innerHTML = peerMessages.map(msg => {
            const isSent = msg.from === credentials.id;
            const expiry = formatExpiry(msg.expires_at, credentials.ttlHours);
            
            return `
                <div class="message ${isSent ? 'message-sent' : 'message-received'}">
                    <div class="message-body">${msg.body}</div>
                    <div class="message-meta">
                        <span>${formatTime(msg.created_at)}</span>
                        ${expiry ? `<span class="ttl-indicator ttl-${expiry.style}">${expiry.text}</span>` : ''}
                    </div>
                    <div class="message-actions">
                        <button class="btn btn-small btn-icon" onclick="archiveMessage('${msg.mid}')" title="Archive">üì¶</button>
                        <button class="btn btn-small btn-icon" onclick="deleteMessage('${msg.mid}')" title="Delete">üóë</button>
                    </div>
                </div>
            `;
        }).join('');
        
        list.scrollTop = list.scrollHeight;
    }
    
    async function sendMessage() {
        const input = document.getElementById('message-input');
        const body = input.value.trim();
        if (!body) return;
        
        try {
            await DeadropAPI.sendMessage(credentials, currentPeerId, body);
            input.value = '';
            
            const result = await DeadropAPI.getInbox(credentials);
            messages = result.messages;
            renderConversation();
        } catch (e) {
            alert('Failed to send: ' + e.message);
        }
    }
    
    async function archiveMessage(mid) {
        if (!confirm('Archive this message?')) return;
        try {
            await DeadropAPI.archiveMessage(credentials, mid);
            messages = messages.filter(m => m.mid !== mid);
            renderConversation();
        } catch (e) {
            alert('Failed to archive: ' + e.message);
        }
    }
    
    async function deleteMessage(mid) {
        if (!confirm('Delete this message permanently?')) return;
        try {
            await DeadropAPI.deleteMessage(credentials, mid);
            messages = messages.filter(m => m.mid !== mid);
            renderConversation();
        } catch (e) {
            alert('Failed to delete: ' + e.message);
        }
    }
    
    // ==================== ROOMS ====================
    
    async function loadRoomsInBackground() {
        try {
            const result = await DeadropAPI.listRooms(credentials);
            rooms = result || [];
            
            // Update badge if there are rooms
            const badge = document.getElementById('rooms-badge');
            const badge2 = document.getElementById('rooms-badge-2');
            if (rooms.length > 0) {
                // Count total unread (we'd need unread API for this)
                // For now, just show count
                badge.classList.add('hidden');
                badge2.classList.add('hidden');
            }
        } catch (e) {
            console.error('Failed to load rooms:', e);
        }
    }
    
    async function loadRooms() {
        const loading = document.getElementById('rooms-loading');
        const list = document.getElementById('room-list');
        const empty = document.getElementById('rooms-empty');
        
        loading.classList.remove('hidden');
        list.innerHTML = '';
        
        try {
            const result = await DeadropAPI.listRooms(credentials);
            rooms = result || [];
            
            loading.classList.add('hidden');
            
            if (rooms.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            list.innerHTML = rooms.map(room => `
                <div class="room-item" onclick="openRoom('${room.room_id}')">
                    <div class="room-icon">üí¨</div>
                    <div class="room-content">
                        <div class="room-header">
                            <span class="room-name">${room.display_name || 'Unnamed Room'}</span>
                            <span class="room-time">${room.created_at ? formatTime(room.created_at) : ''}</span>
                        </div>
                        <div class="room-preview">${room.member_count || '?'} members</div>
                    </div>
                </div>
            `).join('');
            
        } catch (e) {
            loading.classList.add('hidden');
            list.innerHTML = `<div class="error-message">${e.message}</div>`;
        }
    }
    
    async function openRoom(roomId) {
        currentRoomId = roomId;
        history.pushState({}, '', `/app/${currentSlug}/room/${roomId}`);
        
        // Load room details and members
        try {
            const [roomDetails, members] = await Promise.all([
                DeadropAPI.getRoom(credentials, roomId),
                DeadropAPI.listRoomMembers(credentials, roomId),
            ]);
            
            document.getElementById('room-chat-title').textContent = roomDetails.display_name || 'Room';
            
            // Build member map for name lookups
            roomMembers = {};
            (members || []).forEach(m => {
                roomMembers[m.identity_id] = m;
            });
            
            document.getElementById('room-chat-members').textContent = 
                `${Object.keys(roomMembers).length} members`;
            
            showView('roomChat');
            await loadRoomMessages();
            startRoomPolling();
            
        } catch (e) {
            alert('Failed to open room: ' + e.message);
        }
    }
    
    async function loadRoomMessages() {
        const list = document.getElementById('room-message-list');
        
        // Try loading from cache first for instant display
        const cacheKey = `room_messages_${currentRoomId}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            try {
                roomMessages = JSON.parse(cached);
                renderRoomMessages();
            } catch (e) {}
        }
        
        // Show spinner if no cache
        if (!cached) {
            list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        }
        
        try {
            const startTime = performance.now();
            const result = await DeadropAPI.getRoomMessages(credentials, currentRoomId);
            const elapsed = Math.round(performance.now() - startTime);
            console.log(`Room messages loaded in ${elapsed}ms`);
            
            roomMessages = result?.messages || [];
            
            // Save to cache
            localStorage.setItem(cacheKey, JSON.stringify(roomMessages));
            
            // Update subscription cursor
            if (subscriptionManager && roomMessages.length > 0) {
                const lastMid = roomMessages[roomMessages.length - 1].mid;
                subscriptionManager.updateCursor(`room:${currentRoomId}`, lastMid);
            }
            
            renderRoomMessages();
        } catch (e) {
            if (!cached) {
                list.innerHTML = `<div class="error-message">${e.message}</div>`;
            }
        }
    }
    
    function renderRoomMessages() {
        const list = document.getElementById('room-message-list');
        
        // Reverse for column-reverse display (newest at bottom visually)
        const reversed = [...roomMessages].reverse();
        
        list.innerHTML = reversed.map(msg => {
            const isMe = msg.from_id === credentials.id;
            const isPending = msg.pending;
            
            return `
                <div class="room-message ${isMe ? 'from-me' : ''} ${isPending ? 'pending' : ''}">
                    <div class="sender-name">${getMemberName(msg.from_id)}</div>
                    <div class="message-body">${escapeHtml(msg.body)}</div>
                    <div class="message-time">${isPending ? 'Sending...' : formatTime(msg.created_at)}</div>
                </div>
            `;
        }).join('');
        
        // No need to scroll - column-reverse keeps us at bottom
        
        // Update read cursor (skip pending messages)
        const realMessages = roomMessages.filter(m => !m.pending);
        if (realMessages.length > 0) {
            const lastMid = realMessages[realMessages.length - 1].mid;
            DeadropAPI.updateRoomReadCursor(credentials, currentRoomId, lastMid).catch(() => {});
        }
    }
    
    async function sendRoomMessage() {
        const input = document.getElementById('room-message-input');
        const sendBtn = document.getElementById('room-send-btn');
        const body = input.value.trim();
        if (!body) return;
        
        // Immediately clear input and disable button
        input.value = '';
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        
        // Add optimistic message to UI
        const optimisticMsg = {
            mid: 'pending-' + Date.now(),
            from_id: credentials.id,
            body: body,
            created_at: new Date().toISOString(),
            pending: true
        };
        roomMessages.push(optimisticMsg);
        renderRoomMessages();
        
        const startTime = performance.now();
        
        try {
            const result = await DeadropAPI.sendRoomMessage(credentials, currentRoomId, body);
            const elapsed = Math.round(performance.now() - startTime);
            console.log(`Room message sent in ${elapsed}ms`);
            
            // Replace optimistic message with real one
            const idx = roomMessages.findIndex(m => m.mid === optimisticMsg.mid);
            if (idx >= 0) {
                roomMessages[idx] = result;
            }
            renderRoomMessages();
        } catch (e) {
            // Remove optimistic message on error
            roomMessages = roomMessages.filter(m => m.mid !== optimisticMsg.mid);
            renderRoomMessages();
            alert('Failed to send: ' + e.message);
            // Restore the message to input
            input.value = body;
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send ‚û§';
        }
    }
    
    function startRoomPolling() {
        // Skip legacy polling when subscription manager is active ‚Äî
        // the subscription onEvent handler already calls fetchNewRoomMessages().
        if (subscriptionManager) {
            console.log('[polling] skipped ‚Äî subscription manager active');
            return;
        }
        
        // Fallback: use long-polling when subscriptions are unavailable
        if (roomPollController) {
            roomPollController.abort();
        }
        
        roomPollController = new AbortController();
        pollRoomMessages(roomPollController.signal);
    }
    
    async function pollRoomMessages(signal) {
        while (!signal.aborted) {
            try {
                const afterMid = roomMessages.length > 0 ? roomMessages[roomMessages.length - 1].mid : null;
                
                // Use long-polling (wait up to 30 seconds)
                const result = await DeadropAPI.getRoomMessages(credentials, currentRoomId, {
                    afterMid,
                    wait: 30,
                });
                
                if (signal.aborted) break;
                
                if (result?.messages?.length > 0) {
                    // Add new messages
                    roomMessages = [...roomMessages, ...result.messages];
                    // Update cache
                    const cacheKey = `room_messages_${currentRoomId}`;
                    localStorage.setItem(cacheKey, JSON.stringify(roomMessages));
                    renderRoomMessages();
                    
                    // Update subscription cursor for this room
                    if (subscriptionManager) {
                        const lastMid = result.messages[result.messages.length - 1].mid;
                        subscriptionManager.updateCursor(`room:${currentRoomId}`, lastMid);
                    }
                }
                
            } catch (e) {
                if (signal.aborted) break;
                console.error('Room poll error:', e);
                // Wait a bit before retrying on error
                await new Promise(r => setTimeout(r, 5000));
            }
        }
    }
    
    // ==================== UNIFIED SUBSCRIPTION ====================
    
    /**
     * Start the unified subscription manager for the current namespace.
     * Subscribes to inbox + all rooms. Dispatches events to refresh
     * the appropriate views.
     */
    async function startSubscription() {
        stopSubscription();
        
        if (!credentials) return;
        
        subscriptionManager = new SubscriptionManager(credentials);
        
        subscriptionManager.onEvent = async (topic, latestMid) => {
            console.log(`[subscription] event on ${topic}: ${latestMid}`);
            
            if (topic === `inbox:${credentials.id}`) {
                // Inbox has new messages ‚Äî refresh if viewing inbox
                const inboxView = document.getElementById('view-inbox');
                if (!inboxView.classList.contains('hidden')) {
                    loadInbox();
                }
                // Could show a badge on inbox tab if viewing rooms
                const tabInbox = document.getElementById('tab-inbox');
                if (tabInbox && inboxView.classList.contains('hidden')) {
                    tabInbox.style.fontWeight = 'bold';
                }
            } else if (topic.startsWith('room:')) {
                const roomId = topic.substring(5);
                // If we're viewing this room, fetch new messages
                if (currentRoomId === roomId) {
                    await fetchNewRoomMessages(roomId);
                }
                // Could show badge on rooms tab
            }
        };
        
        subscriptionManager.onStatusChange = (status) => {
            console.log(`[subscription] status: ${status}`);
        };
        
        // Build topics: inbox + all rooms
        const roomIds = rooms.map(r => r.room_id);
        const topics = subscriptionManager.buildTopics(roomIds, true);
        
        // Start in background
        subscriptionManager.start(topics).catch(e => {
            console.error('Subscription manager error:', e);
        });
    }
    
    function stopSubscription() {
        if (subscriptionManager) {
            subscriptionManager.stop();
            subscriptionManager = null;
        }
    }
    
    /**
     * Fetch only new room messages (incremental update).
     */
    async function fetchNewRoomMessages(roomId) {
        try {
            const afterMid = roomMessages.length > 0 
                ? roomMessages[roomMessages.length - 1].mid 
                : null;
            
            const result = await DeadropAPI.getRoomMessages(credentials, roomId, { afterMid });
            
            if (result?.messages?.length > 0) {
                roomMessages = [...roomMessages, ...result.messages];
                const cacheKey = `room_messages_${roomId}`;
                localStorage.setItem(cacheKey, JSON.stringify(roomMessages));
                renderRoomMessages();
                
                // Update subscription cursor
                if (subscriptionManager) {
                    const lastMid = result.messages[result.messages.length - 1].mid;
                    subscriptionManager.updateCursor(`room:${roomId}`, lastMid);
                }
            }
        } catch (e) {
            console.error('Failed to fetch new room messages:', e);
        }
    }
    
    // ==================== COMPOSE MODAL ====================
    
    function showCompose() {
        const modal = document.getElementById('compose-modal');
        const select = document.getElementById('compose-to');
        
        select.innerHTML = peers
            .filter(p => p.id !== credentials.id)
            .map(p => `<option value="${p.id}">${p.metadata?.display_name || p.id}</option>`)
            .join('');
        
        select.innerHTML += `<option value="${credentials.id}">Notes to Self</option>`;
        
        modal.classList.remove('hidden');
    }
    
    function hideCompose() {
        document.getElementById('compose-modal').classList.add('hidden');
        document.getElementById('compose-body').value = '';
    }
    
    async function sendCompose() {
        const to = document.getElementById('compose-to').value;
        const body = document.getElementById('compose-body').value.trim();
        
        if (!body) return;
        
        try {
            await DeadropAPI.sendMessage(credentials, to, body);
            hideCompose();
            loadInbox();
        } catch (e) {
            alert('Failed to send: ' + e.message);
        }
    }
    
    // ==================== TAB NAVIGATION ====================
    
    function switchToInbox() {
        document.getElementById('tab-inbox').classList.add('active');
        document.getElementById('tab-inbox-2').classList.add('active');
        document.getElementById('tab-rooms').classList.remove('active');
        document.getElementById('tab-rooms-2').classList.remove('active');
        showView('inbox');
        history.pushState({}, '', `/app/${currentSlug}`);
    }
    
    function switchToRooms() {
        document.getElementById('tab-inbox').classList.remove('active');
        document.getElementById('tab-inbox-2').classList.remove('active');
        document.getElementById('tab-rooms').classList.add('active');
        document.getElementById('tab-rooms-2').classList.add('active');
        showView('rooms');
        loadRooms();
        history.pushState({}, '', `/app/${currentSlug}/rooms`);
    }
    
    // ==================== EVENT LISTENERS ====================
    
    document.getElementById('invite-go-btn').addEventListener('click', () => {
        const url = document.getElementById('invite-url-input').value.trim();
        if (url) window.location.href = url;
    });
    
    document.getElementById('inbox-back').addEventListener('click', (e) => {
        e.preventDefault();
        history.pushState({}, '', '/app');
        currentSlug = null;
        stopSubscription();
        showView('namespaces');
        renderNamespaceList();
    });
    
    document.getElementById('rooms-back').addEventListener('click', (e) => {
        e.preventDefault();
        history.pushState({}, '', '/app');
        currentSlug = null;
        stopSubscription();
        showView('namespaces');
        renderNamespaceList();
    });
    
    document.getElementById('conversation-back').addEventListener('click', (e) => {
        e.preventDefault();
        history.pushState({}, '', `/app/${currentSlug}`);
        currentPeerId = null;
        showView('inbox');
    });
    
    document.getElementById('room-chat-back').addEventListener('click', (e) => {
        e.preventDefault();
        currentRoomId = null;
        switchToRooms();
    });
    
    // Tab navigation
    document.getElementById('tab-inbox').addEventListener('click', (e) => { e.preventDefault(); switchToInbox(); });
    document.getElementById('tab-inbox-2').addEventListener('click', (e) => { e.preventDefault(); switchToInbox(); });
    document.getElementById('tab-rooms').addEventListener('click', (e) => { e.preventDefault(); switchToRooms(); });
    document.getElementById('tab-rooms-2').addEventListener('click', (e) => { e.preventDefault(); switchToRooms(); });
    
    document.getElementById('compose-btn').addEventListener('click', showCompose);
    document.getElementById('compose-cancel').addEventListener('click', hideCompose);
    document.getElementById('compose-close').addEventListener('click', hideCompose);
    document.getElementById('compose-send').addEventListener('click', sendCompose);
    
    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    document.getElementById('room-send-btn').addEventListener('click', sendRoomMessage);
    document.getElementById('room-message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendRoomMessage();
        }
    });
    
    document.getElementById('archived-link').addEventListener('click', async (e) => {
        e.preventDefault();
        history.pushState({}, '', `/app/${currentSlug}/archived`);
        showView('archived');
        
        const list = document.getElementById('archived-list');
        const empty = document.getElementById('archived-empty');
        
        try {
            const result = await DeadropAPI.getArchivedMessages(credentials);
            
            if (result.messages.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            list.innerHTML = result.messages.map(msg => `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div class="card-title">From: ${getPeerName(msg.from)}</div>
                            <div style="margin: 8px 0;">${msg.body}</div>
                            <div class="text-muted text-small">Archived ${formatTime(msg.archived_at)}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-small btn-secondary" onclick="unarchiveMessage('${msg.mid}')">Restore</button>
                            <button class="btn btn-small btn-danger" onclick="deleteMessage('${msg.mid}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            list.innerHTML = `<div class="error-message">${e.message}</div>`;
        }
    });
    
    document.getElementById('archived-back').addEventListener('click', (e) => {
        e.preventDefault();
        history.pushState({}, '', `/app/${currentSlug}`);
        showView('inbox');
    });
    
    async function unarchiveMessage(mid) {
        try {
            await DeadropAPI.unarchiveMessage(credentials, mid);
            document.getElementById('archived-link').click();
        } catch (e) {
            alert('Failed to restore: ' + e.message);
        }
    }
    
    // ==================== INITIALIZE ====================
    
    function init() {
        if (currentSlug) {
            credentials = CredentialStore.getCredentials(currentSlug);
            if (credentials) {
                if (currentView === 'archived') {
                    document.getElementById('inbox-title').textContent = 
                        CredentialStore.getNamespace(currentSlug)?.displayName || currentSlug;
                    showView('archived');
                    document.getElementById('archived-link').click();
                } else if (currentRoomId) {
                    // Deep link to room
                    openNamespace(currentSlug).then(() => openRoom(currentRoomId));
                } else if (currentPeerId) {
                    openNamespace(currentSlug).then(() => openConversation(currentPeerId));
                } else {
                    openNamespace(currentSlug);
                }
            } else {
                showView('namespaces');
                renderNamespaceList();
            }
        } else {
            showView('namespaces');
            renderNamespaceList();
        }
    }
    
    init();
</script>
{% endblock %}
